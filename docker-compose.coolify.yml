# =============================================================================
# SitePod Docker Compose for Coolify
# =============================================================================
#
# Deployment steps:
#
# 1. In Coolify, create a new "Docker Compose" service
# 2. Point to this repo and select this file
# 3. Set environment variables:
#    - SITEPOD_DOMAIN=sitepod.yourdomain.com
# 4. Configure domains in Coolify (see below)
#
# Domain Configuration in Coolify:
# --------------------------------
# You need to add TWO domain entries in Coolify's domain settings:
#
#   1. sitepod.yourdomain.com        → Main domain (console + API)
#   2. *.sitepod.yourdomain.com      → Project subdomains
#
# Beta environment uses -beta suffix (e.g., myapp-beta.sitepod.yourdomain.com)
#
# DNS Configuration:
# ------------------
# Add these DNS records pointing to your Coolify server:
#
#   sitepod.yourdomain.com           A    your-server-ip
#   *.sitepod.yourdomain.com         A    your-server-ip
#
# =============================================================================

services:
  sitepod:
    build:
      context: .
      dockerfile: Dockerfile.coolify
    # Or use pre-built image:
    # image: ghcr.io/sitepod/sitepod:latest
    expose:
      - "8080"
    volumes:
      # Persistent data storage
      - sitepod-data:/data
    environment:
      # Required: Your base domain (without protocol)
      - SITEPOD_DOMAIN=${SITEPOD_DOMAIN:?SITEPOD_DOMAIN is required}
      - SITEPOD_DATA_DIR=/data
      - SITEPOD_STORAGE_TYPE=${SITEPOD_STORAGE_TYPE:-local}

      # S3-compatible storage (optional)
      - SITEPOD_S3_BUCKET=${SITEPOD_S3_BUCKET:-}
      - SITEPOD_S3_REGION=${SITEPOD_S3_REGION:-}
      - SITEPOD_S3_ENDPOINT=${SITEPOD_S3_ENDPOINT:-}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}

      # Quota limits (optional)
      - SITEPOD_MAX_FILES_PER_DEPLOY=${SITEPOD_MAX_FILES_PER_DEPLOY:-10000}
      - SITEPOD_MAX_DEPLOY_SIZE=${SITEPOD_MAX_DEPLOY_SIZE:-524288000}
      - SITEPOD_ANON_MAX_PROJECTS=${SITEPOD_ANON_MAX_PROJECTS:-5}
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:8080/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

volumes:
  sitepod-data:
    driver: local

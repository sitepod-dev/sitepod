# =============================================================================
# SitePod Production Docker Compose
# =============================================================================
#
# Usage:
#   1. Copy this file to docker-compose.yml
#   2. Create .env file with your configuration (see .env.example)
#   3. Run: docker compose up -d
#
# For different deployment scenarios, see docs/deployment.md
# =============================================================================

services:
  sitepod:
    image: ghcr.io/sitepod/sitepod:latest
    # Or build from source:
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    #   target: full
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Persistent data storage
      - sitepod-data:/data
      # Caddy certificates and config
      - caddy-data:/caddy-data
      - caddy-config:/caddy-config
      # Optional: Custom Caddyfile (uncomment to use)
      # - ./Caddyfile:/etc/caddy/Caddyfile:ro
    environment:
      # Required: Your domain
      - SITEPOD_DOMAIN=${SITEPOD_DOMAIN:?SITEPOD_DOMAIN is required}

      # Storage configuration
      - SITEPOD_DATA_DIR=/data
      - SITEPOD_STORAGE_TYPE=${SITEPOD_STORAGE_TYPE:-local}

      # S3-compatible storage (optional)
      - SITEPOD_S3_BUCKET=${SITEPOD_S3_BUCKET:-}
      - SITEPOD_S3_REGION=${SITEPOD_S3_REGION:-}
      - SITEPOD_S3_ENDPOINT=${SITEPOD_S3_ENDPOINT:-}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}

      # Admin account (optional, auto-generated if not set)
      - SITEPOD_ADMIN_EMAIL=${SITEPOD_ADMIN_EMAIL:-}
      - SITEPOD_ADMIN_PASSWORD=${SITEPOD_ADMIN_PASSWORD:-}

      # Quota limits (optional, defaults shown)
      - SITEPOD_MAX_FILES_PER_DEPLOY=${SITEPOD_MAX_FILES_PER_DEPLOY:-10000}
      - SITEPOD_MAX_FILE_SIZE=${SITEPOD_MAX_FILE_SIZE:-104857600}
      - SITEPOD_MAX_DEPLOY_SIZE=${SITEPOD_MAX_DEPLOY_SIZE:-524288000}
      - SITEPOD_MAX_PROJECTS_PER_USER=${SITEPOD_MAX_PROJECTS_PER_USER:-100}
      - SITEPOD_ANON_MAX_PROJECTS=${SITEPOD_ANON_MAX_PROJECTS:-5}
      - SITEPOD_ANON_MAX_DEPLOY_SIZE=${SITEPOD_ANON_MAX_DEPLOY_SIZE:-52428800}

      # Caddy data directories
      - XDG_DATA_HOME=/caddy-data
      - XDG_CONFIG_HOME=/caddy-config
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  sitepod-data:
    driver: local
  caddy-data:
    driver: local
  caddy-config:
    driver: local
